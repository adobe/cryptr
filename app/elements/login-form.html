<!--
Copyright 2017 Adobe. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="login-form">
	<template>
		<style>
			:host {
				--paper-tabs-selection-bar-color: #4496ff;
				--paper-tab-ink: #1671ea;
				--paper-tabs-selection-bar: {
					color: white;
				};
			}
			paper-toast.error {
				background-color: #F44336;
			}
			#userfield, #passfield {
				margin: 0;
			}
			paper-dialog > iron-pages {
				margin: 0;
			}
			paper-dialog > *:last-child {
				margin: 0;
				padding: 0px;
			}
			paper-dialog > *:nth-child(2) {
				margin-top: 60px;
			}
			.flex-horizontal {
				@apply(--layout-horizontal);
			}
			.flexchild {
				@apply(--layout-flex);
			}
			#modal {
				-moz-border-radius: 8px;
				-webkit-border-radius: 8px;
				border-radius: 8px;
			}
			#logo {
				width: 200px;
				height: 200px;
				left: 50%;
				position: absolute;
				top: -122px;
				-webkit-transform: translateX(-50%);
				transform: translateX(-50%);
			}
			.bottombar {
				position: fixed;
				left: 0;
				right: 0;
				bottom: 0;
				width: 100vw;
			}
			paper-progress.bottombar {
				--paper-progress-container-color: rgba(#ffffff, 0);
			}
		</style>

		<iron-ajax id="authenticateReq"
			url="{{authURL}}"
			handle-as="json"
			method="{{authMethod}}"
			body="{{body}}"
			headers="{{header}}"
			content-type="application/json"
			last-response="{{loginResponse}}"
			last-error={{loginError}}
			on-response="_success"
			on-error="_error"
			timeout="30000">
		</iron-ajax>

		<iron-ajax id="testReq"
			url="{{testURL}}"
			handle-as="json"
			last-response="{{testResponse}}"
			on-response="_testSuccess"
			on-error="_testError"
			timeout="5000">
		</iron-ajax>

		<paper-dialog id="modal" class="noselect" entry-animation="scale-up-animation" modal no-cancel-on-esc-key no-cancel-on-outside-click auto-fit-on-attach>
			<iron-image id="logo" sizing="contain" src="../images/cryptr-internal.png"></iron-image>
			<paper-tabs selected="{{page}}">
				<paper-tab>LDAP</paper-tab>
				<paper-tab>Token</paper-tab>
				<paper-tab>User/Pass</paper-tab>
			</paper-tabs>
			<div class="flexchild" style="margin: 0;">
				<paper-input id="urlfield" value="{{domain}}" invalid="{{!approvedURL}}" label=" Server URL" error-message="A Vault server is not found at this URL" disabled="{{loading}}">
					<div prefix>https:// </div>
				</paper-input>
			</div>
			<iron-pages selected="{{page}}">
				<div>
					<iron-a11y-keys target="[[targetuserldap]]" keys="enter" on-keys-pressed="_login"></iron-a11y-keys>
					<iron-a11y-keys target="[[targetpassldap]]" keys="enter" on-keys-pressed="_login"></iron-a11y-keys>
					<paper-input id="userfieldldap" value="{{username}}" label="LDAP Username" disabled="{{loading}}"></paper-input>
					<paper-input id="passfieldldap" value="{{password}}" label="LDAP Password" type="password" disabled="{{loading}}"></paper-input>
				</div>
				<div>
					<iron-a11y-keys target="[[targettoken]]" keys="enter" on-keys-pressed="_login"></iron-a11y-keys>
					<paper-input id="tokenfield" value="{{token}}" label="Token" disabled="{{loading}}"></paper-input>
				</div>
				<div>
					<iron-a11y-keys target="[[targetuser]]" keys="enter" on-keys-pressed="_login"></iron-a11y-keys>
					<iron-a11y-keys target="[[targetpass]]" keys="enter" on-keys-pressed="_login"></iron-a11y-keys>
					<paper-input id="userfield" value="{{username}}" label="Username" disabled="{{loading}}"></paper-input>
					<paper-input id="passfield" value="{{password}}" label="Password" type="password" disabled="{{loading}}"></paper-input>
				</div>
			</iron-pages>
			<div class="buttons">
				<paper-button on-tap="_login" autofocus disabled="{{loading}}">Login</paper-button>
			</div>
			<paper-progress class="bottombar" indeterminate disabled="{{!loading}}"></paper-progress>
		</paper-dialog>

		<paper-toast id="errortoast" class="fit-bottom error" duration="5000">
			<iron-icon prefix icon="error-outline" style="padding-right: 7px;"></iron-icon>
			{{errorText}}
		</paper-toast>
	</template>

	<script>
		(function() {
			'use strict';
			Polymer({
				is: 'login-form',
				properties: {
					status: {
						type: String,
						value: '',
						notify: true,
						observer: '_watchStatus'
					},
					targetuser: {
						value: function() { return this.$.userfield; }
					},
					targetpass: {
						value: function() { return this.$.passfield; }
					},
					targetuserldap: {
						value: function() { return this.$.userfieldldap; }
					},
					targetpassldap: {
						value: function() { return this.$.passfieldldap; }
					},
					targettoken: {
						value: function() { return this.$.tokenfield; }
					},
					username: {
						type: String,
						value: '',
						notify: true,
						observer: '_persistData'
					},
					body: Object,
					password: String,
					authURL: String,
					token: {
						type: String,
						value: ''
					},
					loading: {
						type: Boolean,
						value: false
					},
					url: {
						type: String,
						notify: true,
						observer: '_watchURL'
					},
					domain: {
						type: String,
						notify: true,
						observer: '_watchDomain'
					},
					header: {
						type: Object,
						notify: true
					},
					loginResponse: {
						type: Object,
						notify: true
					},
					page: {
						type: Number,
						value: 0,
						notify: true,
						observer: '_persistData'
					},
					authMethod: {
						type: String,
						value: 'POST'
					},
					authRequests: {
						type: Array,
						value: []
					},
					approvedURL: {
						type: Boolean,
						value: false
					}
				},
				attached: function() {
					this.status = 'none';
				},
				_computeBody: function(p) {
					return {"password": p };
				},
				_computeURL: function(url, u) {
					return this.url + 'v1/auth/ldap/login/' + u
				},
				_login: function() {
					this.url = this.url.trim();
					if (this.url.toLowerCase().startsWith('https')) {
						if (!(this.url.endsWith('/'))) this.url += '/';
						// Switch for LDAP, Token, and UserPass auth backends
						if (this.page == 0) {
							if (!this.username && !this.password) { //Check fields have content
								this.errorText = 'Username and Password are required';
								this.$.errortoast.show();
								this.loading = false;
								return;
							}
							this.authMethod = 'POST';
							this.authURL = this.url + 'v1/auth/ldap/login/' + this.username;
							this.body = {"password": this.password };
						} else if (this.page == 1) {
							if (!this.token) { //Check field has content
								this.errorText = 'Token is required';
								this.$.errortoast.show();
								this.loading = false;
								return;
							}
							this.authMethod = 'GET';
							this.authURL = this.url + 'v1/auth/token/lookup-self';
							this.header = {"X-Vault-Token": this.token };
							this.body = '';
						} else if (this.page == 2) {
							if (!this.username && !this.password) { //Check fields have content
								this.errorText = 'Username and Password are required';
								this.$.errortoast.show();
								this.loading = false;
								return;
							}
							this.authMethod = 'POST';
							this.authURL = this.url + 'v1/auth/userpass/login/' + this.username;
							this.body = {"password": this.password };
						}
						this.loading = true;
						this.push('authRequests', this.$.testReq.generateRequest());
					} else {
						this.errorText = 'An HTTPS based URL is required.';
						this.$.errortoast.show();
						this.loading = false;
					}
				},
				_success: function() {
					this.$.errortoast.close()
					// UserPass / LDAP
					if (this.loginResponse.auth && this.loginResponse.auth.client_token) {
						this.header = {"X-Vault-Token": this.loginResponse.auth.client_token };
						this.loginResponse = this.loginResponse.auth;
						this.status = 'watch';
						this.password = '';
						document.getElementById('blocker').style.display = 'none';
						this.$.modal.close();
					// Token Auth
					} else if (this.loginResponse.data) {
						this.loginResponse = this.loginResponse.data;
						this.username = 'TOKEN';
						this.status = 'watch';
						this.password = '';
						this.$.modal.close();
					}
				},
				_error: function(e) {
					this.loading = false;
					if (this.loginError.response.errors[0].includes('Invalid Credentials')) this.errorText = 'Invalid Credentials';
					else if (this.loginError.response.errors[0].includes('No Such Object')) this.errorText = 'Invalid Username or Password';
					else if (this.loginError.response.errors[0] == 'invalid username or password') this.errorText = 'Invalid Username or Password';
					else if (this.loginError.response.errors[0] == 'missing client token') this.errorText = 'Permission Denied';
					else if (this.loginError.response.errors[0] == 'Vault is sealed') this.errorText = 'This vault is currently sealed';
					else if (this.loginError.response.errors[0] == 'unsupported path') this.errorText = 'This auth backend is not supported by the server';
					else if (this.loginError.response.errors[0] == 'permission denied' && this.page == 1) this.errorText = 'Invalid Token';
					else if (this.loginError.response.errors[0] == 'permission denied') this.errorText = 'Permission Denied';
					else this.errorText = 'Unknown Error: Please try again later.';
					this.$.errortoast.show();
				},
				_testSuccess: function() {
					if (!this.testResponse.hasOwnProperty('t') || 
						!this.testResponse.hasOwnProperty('n') || 
						!this.testResponse.hasOwnProperty('progress') || 
						!this.testResponse.hasOwnProperty('version') || 
						!this.testResponse.hasOwnProperty('cluster_id') || 
						!this.testResponse.hasOwnProperty('cluster_name')) {
						this.errorText = 'No supported Vault instance found at the this URL';
						this.$.errortoast.show();
						this.approvedURL = false;
						this.loading = false;
						return;
					} else if (this.testResponse.sealed) {
						this.errorText = 'Vault is sealed.';
						this.$.errortoast.show();
						this.approvedURL = false;
						this.loading = false;
					} else {
						this.approvedURL = true;
						this._watchAuthRequests();
					}
				},
				_testError: function() {
					this.errorText = 'No supported Vault instance found at the this URL';
					this.$.errortoast.show();
					this.approvedURL = false;
					this.loading = false;
					this.authRequests = [];
				},
				_watchStatus: function() {
					if (this.status == 'none') this.$.modal.open();
				},
				_watchURL: function() {
					this.debounce('checkURL', function () {
						if (this.url.toLowerCase().startsWith('https')) {
							if (!(this.url.endsWith('/'))) {
								this.testURL = this.url + '/v1/sys/seal-status';
								this.$.testReq.generateRequest();
							} else {
								this.testURL = this.url + 'v1/sys/seal-status';
								this.$.testReq.generateRequest();
							}
						} else {
							this.approvedURL = false;
						}
						this._persistData();
					}, 400);
				},
				_watchAuthRequests: function() {
					if (this.authRequests[0]) {
						this.$.authenticateReq.generateRequest();
						this.authRequests = [];
					}
				},
				_watchDomain: function() {
					this.domain = (this.domain) ? this.domain.toLowerCase().replace('https://', '') : '';
					this.url = 'https://' + this.domain;
				},
				_persistData: function() {
					ipcRenderer.send('update-domain', this.domain);
					ipcRenderer.send('update-user', this.username);
					ipcRenderer.send('update-loginpage', this.page);
				}
			});
		})();
	</script>
</dom-module>
