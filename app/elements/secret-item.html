<!--
Copyright 2017 Adobe. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<dom-module id="secret-item">
	<style>
		:host {
		}
		.flex {
			@apply(--layout-flex);
		}
		.center {
			margin-bottom: 50px;
			@apply(--layout-horizontal);
		}
		.centercenter {
			height: calc(100vh - 286px);
			@apply(--layout-center-center);
		}
		.vertical {
			@apply(--layout-vertical);
		}
		.horizontal {
			@apply(--layout-horizontal);
		}
		.justified {
			@apply(--layout-center-justified);
		}
		.end-justified {
			@apply(--layout-end-justified);
		}
		paper-toast.success {
			background-color: #4CAF50;
		}
		paper-toast.error {
			background-color: #F44336;
		}
		a {
			color: black;
			text-decoration: none;
		}
		.topbar {
			background-color: var(--accent-color);
			width: 100%; 
			height: 110px;
			color: white;
		}
		#topbar-input {
			--paper-input-container-input-color: white;
			--paper-input-container-color: var(--accent-color);
			--paper-input-container-focus-color: white;
		}
		h2 {
			margin: 0.83em 0 0 0;
		}
		paper-button {
			border: 2px solid #4496ff;
		    padding: 0px;
		    height: 34px;
		    margin-top: 7px;
		    color: #308aff;
		    font-weight: 500;
		}
		paper-button[disabled] {
			color: #c4d8f9 !important;
			background: transparent;
			border: 2px solid #afceff !important;
			font-weight: 700
		}
		#buttonmove {
			color: #fff;
			font-weight: 400;
			border: 2px solid #fff;
			min-width: 67px;
		}
		#file {
			color: rgba(56, 67, 81, 0.14);
			width: 250px;
			height: 250px;
		}
		#deleteModal {
			border-radius: 3px;
		}
		
	</style>
	<template>
		<iron-ajax id="getSecret"
			url="{{secretURL}}"
			handle-as="json"
			headers="{{header}}"
			on-error="_getError"
			on-response="_getSuccess"
			last-response="{{response}}">
		</iron-ajax>

		<iron-ajax id="deleteSecret"
			url="{{secretURL}}"
			handle-as="json"
			method="delete"
			headers="{{header}}"
			on-error="_deleteError"
			on-response="_deleteSuccess"
			last-response="{{response}}">
		</iron-ajax>

		<iron-ajax id="updateSecret"
			url="{{secretURL}}"
			method="post"
			body="{{body}}"
			handle-as="json"
			content-type="application/json"
			headers="{{header}}"
			on-error="_updateError"
			on-response="_updateSuccess"
			last-response="{{response}}">
		</iron-ajax>

		<iron-ajax id="capabilities"
			url="{{capabilitiesURL}}"
			method="post"
			body="{{body}}"
			handle-as="json"
			on-error="_watchCapabilitiesRequests"
			on-response="_watchCapabilitiesRequests"
			content-type="application/json"
			headers="{{header}}">
		</iron-ajax>

		<paper-toast id="updated" class="success fit-bottom" duration="1500">
			<iron-icon prefix icon="info-outline" style="padding-right: 7px;"></iron-icon>
			Updated
		</paper-toast>
		<paper-toast id="error" class="error fit-bottom" duration="5000">
			<iron-icon prefix icon="error-outline" style="padding-right: 7px;"></iron-icon>
			{{errorText}}
		</paper-toast>
		<paper-toast id="secretexists" class="fit-bottom" duration="0">
			<iron-icon prefix icon="info-outline" style="padding-right: 7px;"></iron-icon>
			A secret already exists at this location! Continuing will overwrite it.
		</paper-toast>
		<paper-toast id="added" class="success fit-bottom" duration="1500">
			<iron-icon prefix icon="check" style="padding-right: 7px;"></iron-icon>
			Secret Added
		</paper-toast>
		
		<paper-dialog id="deleteModal" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
			<h2>Delete?</h2>
			<p>Are you sure you want to delete this item?</p>
			<div class="buttons">
				<paper-button dialog-dismiss on-tap="_cancelDelete">Cancel</paper-button>
				<paper-button dialog-confirm autofocus on-tap="_deleteKey">Delete</paper-button>
			</div>
		</paper-dialog>

		<div class="flex">
			<div class="topbar">
				<div class="horizontal justified">
					<h2>{{currentName}}</h2>
				</div>
				<div class="horizontal justified">
					<paper-item>Location:</paper-item>
					<paper-item>
						<paper-input id="topbar-input" value="{{newLocation}}" label="Location" no-label-float style="width: 220px;"></paper-input>
					</paper-item>
					<paper-button id="buttonmove" on-tap="_moveKey" disabled="{{moveDisabled}}">Move</paper-button>
				</div>
			</div>
			<div class="horizontal">
				<paper-button on-tap="_confirmDelete">Delete</paper-button>
				<paper-button on-tap="_updateKey">Update</paper-button>
				<div class="flex"></div>
				<paper-toggle-button id="hidevalues" checked="{{hideValues}}" disabled="{{hideValuesDisabled}}" style="padding-right: 30px">Hide Values</paper-toggle-button>
				<paper-toggle-button on-change="_toggleJSON" id="json" style="padding-right: 20px">Raw</paper-toggle-button>
			</div>
			<div class="center justified" style="padding-top:20px">
				<iron-pages selected="{{selected}}">
					<section>
						<secret-structure data="{{data}}" indent="0" hide-values="{{hideValues}}"></secret-structure>
					</section>
					<section>
						<div class="vertical centercenter">
							<iron-icon id="file" icon="editor:insert-drive-file"></iron-icon>
							<div>
								{{response.data.filename}}
							</div>
							<a download$="{{response.data.filename}}" href$="{{response.data.data}}">
								<paper-button style="padding: 7px;">Download</paper-button>
							</a>
						</div>
						<!-- <granite-file-reader read-as="dataURL" on-file-read="_fileUpload">
							  <paper-button>
								  Upload File
							  </paper-button>
						  </granite-file-reader> -->
					</section>
					<section>
						<juicy-jsoneditor id="jsoneditor" json="{{data}}" modes="['code', 'form', 'text', 'tree', 'view']" history="true" search="false"></juicy-jsoneditor>
					</section>
				</iron-pages>
			</div>
		</div>
	</template>

	<script>
	Polymer({
		is: "secret-item",
		properties: {
			secrets: {
				type: Array,
				notify: true
			},
			header: Object,
			url: String,
			hideValues: Boolean,
			newLocation: {
				type: String,
				observer: '_watchNewLocation'
			},
			location: {
				type: String,
				observer: '_watchLocation'
			},
			data: {
				type: Object,
				value: {},
				notify: true
			},
			selected: {
				type: Number,
				value: 0
			},
			body: Object,
			loading: {
				notify: true
			},
			capabilitiesRequests: {
				type: Array,
				value: []
			},
			moveRequest: {
				type: Object,
				value: {}
			},
			errorText: {
				type: String,
				value: 'An unknown error occurred'
			}
		},
		attached: function() {
			this.$.secretexists.fitInto = headerPanelMain;
			this.$.added.fitInto = headerPanelMain;
			this.$.updated.fitInto = headerPanelMain;
			this.$.error.fitInto = headerPanelMain;
		},
		// ---------- Other ----------
		_fileUpload: function(e, file){
			console.log('FILE: ', file);
		},
		_reAddSecret: function() {
			var parts = this.moveRequest.newLocation.split('/');
			var name = parts.pop();
			var secretExists = false;
			// Replace secret in this.secrets array, unless it already exists, in which case replace it
			var newSecret = {location: this.moveRequest.newLocation, value: {}, type: "secret", parent: parts.join('/'), name: name, parsedname: name.replace(/_/g, ' ')}
			for (var j = 0; j < this.secrets.length; j++) {
				if (this.secrets[j].location == this.moveRequest.newLocation) {
					this.set('this.secrets.' + j, newSecret);
					secretExists = true;
				}
			}
			if (!secretExists) this.push('secrets', newSecret);
			// Add containing folder
			var found = false;
			for (var i = parts.length - 1; i > 0; i--) {
				for (var i = 0; i < this.secrets.length; i++) {
					if (this.secrets[i].location == parts.join('/')) {
						found = true;
						break;
					}
				}
				if (!found) {
					var loc = parts.join('/');
					var foldername = parts.pop();
					this.push('secrets', {location: loc, value: {}, type: "folder", parent: parts.join('/'), name: foldername, parsedname: foldername.replace(/_/g, ' ')});
				} else break;
			}
		},
		_deleteContainingFolder: function(location) {
			var found = false;
			var index = -1;
			for (var i = 0; i < this.secrets.length; i++) {
				if (this.secrets[i].parent == location) found = true;
				if (this.secrets[i].location == location && this.secrets[i].type == 'folder') index = i;
			}
			if (!found) {
				this.splice('secrets', index, 1);
				var parts = location.split('/');
				parts.pop();
				this._deleteContainingFolder(parts.join('/'));
			}
		},
		_toggleJSON: function(e) {
			if (e.target.checked) {
				this.hideValuesDisabled = true;
				this.selected = 2;
			} else {
				this.hideValuesDisabled = false;
				if ( this.data.filename && this.data.type && this.data.type == 'file' ) this.selected = 1;
				else {
					// Force Polymer to override dirty checking and restamp
					var temp = this.data;
					this.data = {};
					this.data = temp;
					this.selected = 0;
				}
			}
		},
		// ---------- Watch ----------
		_watchNewLocation: function() {
			if (this.newLocation != this.location) this.moveDisabled = false;
			else this.moveDisabled = true;
			if (this.secrets) {
				for (var i = 0; i < this.secrets.length; i++) {
					if (this.secrets[i].location == this.newLocation && this.location != this.newLocation) {
						this.$.secretexists.show();
						return;
					}
				}
				this.$.secretexists.hide();
			}
		},
		_watchCapabilitiesRequests: function() {
			// Wait for all capabilities requests to return.
			var complete = true;
			for (var i = 0; i < this.capabilitiesRequests.length; i++)
				if (this.capabilitiesRequests[i].status == 0) complete = false;
			if (complete) {
				if (this.capabilitiesRequests[0].response.data.capabilities.includes('delete')) {
					if (this.capabilitiesRequests[1].response.data.capabilities.includes('create')) {
						// Execute Move step #2 on new location.
						this.secretURL = app.url + 'v1/' + this.newLocation;
						this.moveRequest = {
							oldLocation: this.location,
							newLocation: this.newLocation,
							update: this._updateKey(),
							delete: {}
						};
					}
				} else {
					this.errorText = "You don't have the rights to move this secret. Check for 'Delete' and 'Create' capabilities failed.";
					this.$.error.show();
					this.loading = false;
				}
			}
		},
		_clear: function() {
			this.secretURL = app.url + 'v1/' + this.location;
			this.capabilitiesURL = app.url + 'v1/sys/capabilities-self';
			this.url = app.url + 'v1';
			this.currentName = '';
			this.data = {};
			this.selected = 0;
			this.moveDisabled = true;
			this.$.json.checked = false;
			this.hideValues = true;
			this.hideValuesDisabled = false;
			this.response = {};
		},
		_watchLocation: function() {
			if (this.location !== '') {
				this._clear();
				this.newLocation = this.location;
				this.loading = true;
				this.$.getSecret.generateRequest();
			}
		},
		_watchMoveRequest: function(request) {
			if (Object.keys(this.moveRequest).length) {
				if (Object.keys(this.moveRequest.delete).length && this.moveRequest.delete.status == 204) { // Move process complete
					this.moveRequest = {};
					this.loading = false;
					document.getElementById('move').show();
				} else if (Object.keys(this.moveRequest.delete).length && this.moveRequest.delete.status != 204) { // Delete failed
					this.moveRequest = {}
					this.loading = false;
					this.errorText = "Move failed. You may want to check both old and new locations for duplicates";
					this.$.error.show();
				} else if (Object.keys(this.moveRequest.update).length && this.moveRequest.update.status == 204) { // Update complete, now delete
					this._deleteKey();
				} else if (Object.keys(this.moveRequest.update).length && this.moveRequest.update.status != 204) { // Update failed
					this.moveRequest = {};
					this.loading = false;
				} else { // Catch all error
					this.moveRequest = {};
					this.loading = false;
					this.errorText = "Move: An unknown error occurred";
					this.$.error.show();
				}
				return true;
			} else return false;
		},
		// ---------- Confirm ----------
		_confirmDelete: function() {
			this.$.deleteModal.open();
		},
		_cancelDelete: function() {
			this.$.deleteModal.close();
		},
		// ---------- Execute ----------
		_deleteKey: function() {
			if (this.moveRequest && this.moveRequest.oldLocation) {
				this.secretURL = app.url + 'v1/' + this.moveRequest.oldLocation;
				this.moveRequest.delete = this.$.deleteSecret.generateRequest();
			} else this.$.deleteSecret.generateRequest();
			this.loading = true;
		},
		_updateKey: function() {
			this.body = this.data;
			this.loading = true;
			return this.$.updateSecret.generateRequest();
		},
		_moveKey: function() {
			if (this.newLocation.endsWith('/')) {
				this.errorText = "Location must be a full path including the key name. It cannot end with '/' ";
				this.$.error.show();
			} else {
				// Move: 1. Check for Delete and Create capabilities on respective locations. 2. Create new secret, wait for success. 3. Delete old secret
				if (this.location == this.newLocation) {
					this.errorText = "You must specify a new location for this secret!";
					this.$.error.show();
				} else {
					this.body = {path: this.location};
					this.push('capabilitiesRequests', this.$.capabilities.generateRequest());
					this.body = {path: this.newLocation};
					this.push('capabilitiesRequests', this.$.capabilities.generateRequest());
					this.loading = true;
				}
			}
		},
		// ---------- Success ----------
		_getSuccess: function(e) {
			this.loading = false;
			this.data = this.response.data;
			if ( this.response.data.filename &&
				this.response.data.type &&
				this.response.data.type == 'file' ) {
					this.selected = 1;
			} else this.selected = 0;
			for (var i = 0; i < this.secrets.length; i++) {
				if (this.secrets[i].location == this.location) {
					this.secrets[i].value = this.response.data;
					this.currentName = this.secrets[i].parsedname;
					break;
				}
			}
		},
		_deleteSuccess: function(e) {
			this.loading = false;
			this.secretURL = app.url + 'v1/' + this.location;
			for (var i = 0; i < this.secrets.length; i++) {
				if (this.secrets[i].location == this.location && this.secrets[i].type == 'secret') {
					var secret = this.splice('secrets', i, 1);
					if (Object.keys(this.moveRequest).length) this._reAddSecret(this.moveRequest); // Check if secret is moved
					this._deleteContainingFolder(secret[0].parent);
					break;
				}
			}
			if (!this._watchMoveRequest()) document.getElementById('deleted').show();
			page('#!/');
		},
		_updateSuccess: function() {
			this.loading = false;
			if (!this._watchMoveRequest()) this.$.updated.show();
		},
		// ---------- Error ----------
		_getError: function(e) {
			this.loading = false;
			this.errorText = "An error occurred while retrieving this secret. Check permissions?";
			this.$.error.show();
		},
		_deleteError: function(e) {
			this.loading = false;
			this.errorText = "An error occurred while deleting this secret. Check permissions?";
			this.$.error.show();
		},
		_updateError: function(e) {
			this.loading = false;
			this.errorText = "An error occurred while updating this secret. Check permissions?";
			this.$.error.show();
		}
	});
	</script>
</dom-module>
