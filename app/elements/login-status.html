<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="login-status">
	<template>
		<style>
		#errortoast {
			background-color: #EF5350;
		}
		</style>
		<iron-ajax id="checkStatus"
			url="{{statusURL}}"
			handle-as="json"
			headers="{{header}}"
			last-response="{{response}}"
			on-response="_success"
			on-error="_error">
		</iron-ajax>

	</template>

	<script>
		(function() {
			'use strict';

			Polymer({
				is: 'login-status',
				properties: {
					status: {
						type: String,
						notify: true,
						observer: '_watchStatus'
					},
					timer: {
						type: Number,
						notify: true
					},
					url: {
						type: String
					},
					statusURL: {
						computed: '_computeURL(url)'
					},
					header: Object
				},
				_computeURL: function(url) {
					return this.url + 'v1/auth/token/lookup-self'
				},
				_watchStatus: function() {
					if (this.status == 'watch') {
						this.timer = setInterval(function() {
							var stat = document.querySelector('#checkStatus');
							stat.generateRequest();
						}, 61000);
					}
				},
				_success: function() {
					if (this.response.status == 'success') {
						clearInterval(this.timer);
						this.status = 'watch';
					}
				},
				_error: function() {
					this.status = 'none';
					app.response = {};
					app.loginResponse = {};
					app.header = {};
					app.data = {};
					app.access = {};
					app.query = '';
					app.secrets = [];
					clearInterval(this.timer);
				}
			});
		})();
	</script>
</dom-module>
